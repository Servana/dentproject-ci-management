############
# BUILDERS #
############

- builder:
    name: infra-sysstat
    builders:
      - shell: !include-raw:
          - ../../shell/sysstat.sh
##############
# PUBLISHERS #
##############


- publisher:
    name: infra-publish
    # infra macro to finish up a build.
    #
    # Handles the following:
    #   - Shipping logs to Nexus logs site repository
    #   - Cleanup workspace
    publishers:
      - postbuildscript:
          builders:
            - role: BOTH
              build-on:
                - ABORTED
                - FAILURE
                - NOT_BUILT
                - SUCCESS
                - UNSTABLE
              build-steps:
                - infra-sysstat
          mark-unstable-if-failed: true
      - archive:
          artifacts: 'builds/amd64/installer/installed/builds/stretch/**'
          allow-empty: 'true'
          fingerprint: true
          default-excludes: false
      - workspace-cleanup:
          exclude:
            # Do not clean up *.jenkins-trigger files for jobs that use a
            # properties file as input for triggering another build.
            - "**/*.jenkins-trigger"
          fail-build: false

#######
# SCM #
#######

- scm:
    name: infra-github-scm
    scm:
      - git:
          url: "{url}"
          refspec: "{refspec}"
          branches:
            - "{branch}"
          skip-tag: true
          wipe-workspace: true
          submodule:
            disable: "{submodule-disable}"
            recursive: "{submodule-recursive}"
            timeout: "{submodule-timeout}"
          choosing-strategy: "{choosing-strategy}"

############
# WRAPPERS #
############


- wrapper:
    name: infra-wrappers
    wrappers:
      - infra-wrappers-common:
          build-timeout: "{build-timeout}"

- wrapper:
    name: infra-wrappers-common
    wrappers:
      - mask-passwords
      - timeout:
          type: absolute
          timeout: "{build-timeout}"
          timeout-var: "BUILD_TIMEOUT"
          fail: true
      - timestamps